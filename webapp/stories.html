<!DOCTYPE html>
<html class="mdc-typography">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Immigrant News</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
    <link rel="stylesheet" href="aa-style.css">
    <link rel="stylesheet" href="assets/percircle/css/percircle.css" />
</head>
<body class="demo-body mdc-typography">
    <aside class="mdc-persistent-drawer">
        <nav class="mdc-persistent-drawer__drawer">
            <div class="mdc-persistent-drawer__toolbar-spacer"></div>
            <div class="mdc-list-group">
                <nav class="mdc-list">
                    <a class="mdc-list-item mdc-persistent-drawer--selected" href="#">
                        <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">inbox</i>Inbox
                    </a>
                    <a class="mdc-list-item" href="#">
                        <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">star</i>Star
                    </a>
                    <a class="mdc-list-item" href="#">
                        <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">send</i>Sent Mail
                    </a>
                    <a class="mdc-list-item" href="#">
                        <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">drafts</i>Drafts
                    </a>
                </nav>

                <hr class="mdc-list-divider">

                <nav class="mdc-list">
                    <a class="mdc-list-item" href="#">
                        <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">email</i>All Mail
                    </a>
                    <a class="mdc-list-item" href="#">
                        <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">delete</i>Trash
                    </a>
                    <a class="mdc-list-item" href="#">
                        <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">report</i>Spam
                    </a>
                </nav>
            </div>
        </nav>
    </aside>
    <div class="demo-content">
        <header class="mdc-toolbar mdc-toolbar--fixed">
            <div class="mdc-toolbar__row">
                <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
                    <button class="demo-menu material-icons mdc-toolbar__menu-icon">menu</button>
                    <span class="mdc-toolbar__title catalog-title">Immigrant news</span>
                </section>
            </div>
        </header>

        <main class="mdc-toolbar-fixed-adjust">
            <section class="bar">
                <div class="mdc-layout-grid">
                    <div class="mdc-layout-grid__inner">
                        <div class="mdc-layout-grid__cell--span-1-desktop  mdc-layout-grid__cell--span-1-tablet mdc-layout-grid__cell--span-1-phone">
                            <section>
                                <div style="padding:0.5rem 0 0.5rem 0.5rem;">
                                    <span class="avatar-circle">
                                        <img id="user-avatar" title="Credibility rate of this user" style="filter: brightness(30.6%) sepia(100) saturate(84.6) hue-rotate(337deg);" />
                                    </span>
                                </div>
                            </section>
                        </div>
                        <div class="mdc-layout-grid__cell--span-9-desktop  mdc-layout-grid__cell--span-5-tablet mdc-layout-grid__cell--span-1-phone" style="padding-top:1.5rem;">
                            <h1 class="mdc-card__title" id="storyTitle" style="margin:0;">ICE Raid Illinois</h1>
                            <h2 class="mdc-card__subtitle" style="margin:0;"><a id="storyAuthor" href="#">Author</a></h2>
                        </div>
                            <div class="mdc-layout-grid__cell--span-1-desktop mdc-layout-grid__cell--span-1-tablet mdc-layout-grid__cell--span-1-phone right-align">
                                <button class="mdc-button full-height full-width">
                                    Follow
                                </button>
                            </div>
                            <div class="mdc-layout-grid__cell--span-1-desktop mdc-layout-grid__cell--span-1-tablet mdc-layout-grid__cell--span-1-phone right-align">
                                <button id="contributionsButton" class="mdc-button full-height full-width" title="Contributors"></button>
                            </div>
                        </div>
                </div>
            </section>
            <section style="padding: 0.2rem 0.2rem 0.2rem 0.2rem">
                <div class="mdc-text-field mdc-text-field--box mdc-text-field--with-leading-icon mdc-text-field--upgraded mdc-ripple-upgraded mdc-text-field--disabled full-width">
                    <i class="material-icons mdc-text-field__icon" tabindex="0">event</i>
                    <input type="text" id="tf-box-leading" class="mdc-text-field__input custom-text-field-input">
                    <label id="storyDate" for="tf-box-leading" class="mdc-text-field__label">10/01/17</label>
                    <div class="mdc-text-field__bottom-line"></div>
                </div>
                <div class="mdc-text-field mdc-text-field--box mdc-text-field--with-leading-icon mdc-text-field--upgraded mdc-ripple-upgraded mdc-text-field--disabled full-width">
                    <i class="material-icons mdc-text-field__icon" tabindex="0">place</i>
                    <input type="text" id="tf-box-leading" class="mdc-text-field__input custom-text-field-input">
                    <label id="storyLocation" for="tf-box-leading" class="mdc-text-field__label">Aurora, IL</label>
                    <div class="mdc-text-field__bottom-line"></div>
                </div>
                <div class="mdc-text-field mdc-text-field--fullwidth mdc-text-field--textarea mdc-text-field--disabled min-margin">
                    <textarea id="storyDescription" id="full-width-textarea" class="mdc-text-field__input">An Ice raid occured on 10/01/17 at my factory in Aurora. Authorities took 2 men.</textarea>
                </div>
            </section>
            <section class="bar fixed-heigh-bar">
                <div class="mdc-layout-grid">
                    <div class="mdc-layout-grid__inner">
                        <div class="mdc-layout-grid__cell--span-11-desktop  mdc-layout-grid__cell--span-7-tablet mdc-layout-grid__cell--span-3-phone">
                            <section style="padding-left: 1em;">
                                <h2 class="mdc-typography--title">
                                    <i class="material-icons">comment</i>
                                    Comments
                                </h2>
                            </section>
                        </div>
                        <div class="mdc-layout-grid__cell--span-1-desktop mdc-layout-grid__cell--span-1-tablet mdc-layout-grid__cell--span-1-phone right-align">
                            <button id="addCommentary" class="mdc-button full-height full-width" title="Add a new commentary">
                                Add
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="addCommentarySection" style="padding-left: 1em;">
                <div class="mdc-layout-grid">
                    <div class="mdc-layout-grid__inner">
                        <div class="mdc-layout-grid__cell--span-10-desktop  mdc-layout-grid__cell--span-6-tablet mdc-layout-grid__cell--span-2-phone">
                            <label for="text-field-no-js">Commentary: </label>
                            <div class="mdc-text-field full-width">
                                <input type="text" id="commentaryInputText" class="mdc-text-field__input" placeholder="Write your commentary here...">
                                <div class="mdc-text-field__bottom-line"></div>
                            </div>
                        </div>
                        <div class="mdc-layout-grid__cell--span-2-desktop  mdc-layout-grid__cell--span-2-tablet mdc-layout-grid__cell--span-2-phone right-align">
                            <button id="addCommentButton" class="mdc-button full-height">
                                Comment
                            </button>
                            <button id="cancelCommentButton" class="mdc-button full-height">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            <section>
                <ul id="storyComments" class="mdc-list mdc-list--avatar-list comment-list"></ul>
            </section>

            <footer>
                <section class="footer">
                    <div class="mdc-layout-grid">
                        <div class="mdc-layout-grid__inner">
                            <div class="mdc-layout-grid__cell--span-1-desktop  mdc-layout-grid__cell--span-1-tablet mdc-layout-grid__cell--span-1-phone">
                                <button class="mdc-button full-height full-width alert" title="Report as innapriopriate">
                                    <i class="material-icons mdc-button__icon">report problem</i>
                                </button>
                            </div>
                            <div class="mdc-layout-grid__cell--span-11-desktop mdc-layout-grid__cell--span-7-tablet mdc-layout-grid__cell--span-3-phone right-align">
                                <a id="contribute" class="mdc-button mdc-button--raised secondary-filled-button full-height full-width" title="Validate this story" href="contribute.html">
                                    Contribute
                                </a>
                            </div>
                        </div>
                    </div>
                </section>
            </footer>
        </main>
    </div>
    <!--SCRIPT TO ADD FIREBASE TO OUR APP: NEEDS TO BE AT THE END OF THE HTML FILE BEFORE ALL OTHER SCRIPTS  -->
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
    <script>
        // Initialize Firebase
        var config = {
            apiKey: "AIzaSyA-I9XVJya_5zR-BsXSYct7W8zCxkPh7PM",
            authDomain: "immigrant-news.firebaseapp.com",
            databaseURL: "https://immigrant-news.firebaseio.com",
            projectId: "immigrant-news",
            storageBucket: "immigrant-news.appspot.com",
            messagingSenderId: "598567031572"
        };
        firebase.initializeApp(config);
    </script>
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
    <script src="assets/percircle/js/percircle.js" type="text/javascript"></script>
    <script src="story.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var currentStory = null;
            var currentUser = null; 
            //source: https://stackoverflow.com/questions/19491336/get-url-parameter-jquery-or-how-to-get-query-string-values-in-js
            var getUrlParameter = function getUrlParameter(sParam) {
                var sPageURL = decodeURIComponent(window.location.search.substring(1)),
                    sURLVariables = sPageURL.split('&'),
                    sParameterName,
                    i;

                for (i = 0; i < sURLVariables.length; i++) {
                    sParameterName = sURLVariables[i].split('=');

                    if (sParameterName[0] === sParam) {
                        return sParameterName[1] === undefined ? true : sParameterName[1];
                    }
                }
            };

            var storyId = getUrlParameter("id");
            currentStory = storyId;
            currentUser = "Panda";
            var storyUrl = "https://immigrant-news.firebaseio.com/stories/story" + storyId + ".json";
            var commentsUrl = "https://immigrant-news.firebaseio.com/stories/story" + storyId + "/comments.json"; 

            $('#contribute').attr('href', 'contribute.html?id=' + storyId);
            //story data
            $.getJSON(storyUrl, function (data) {
                if (data != null) {
                    //alert(data.date);
                    FillStoryFields(data);
                    SetUserAvatar(data.user, true);
                    SetStoryValidation(data.validations);
                }
            });

            //comments
            $.getJSON(commentsUrl, function (data) {
                DisplayComments(data);
            });

            //fill the fields
            function FillStoryFields(story) {
                $('#storyTitle').text(story.title);
                $('#storyDate').text(story.date);
                $('#storyLocation').text(story.location);
                $('#storyDescription').text(story.description);
                $('#storyAuthor').text(story.user);
                $('#storyAuthor').attr('href', 'userProfile.html?user=' + story.user);
            }

            //display comments
            function DisplayComments(comments) {
                if (comments != null) {
                    $.each(comments, function (index, value) {
                        $('#storyComments').append(GetCommnetaryTemplate(value));
                        //set the commentary user credibility avatar
                        SetUserAvatar(value.user, false);
                    });
                }
                else {
                    $('#storyComments').append('<li class="mdc-list-item comment-box comment-list-item">' +
                        '<div>' +
                        'Be the first to comment this story!' +
                        '</div>' +
                        '</li>');
                }
            }

            //get a commentary html template
            function GetCommnetaryTemplate(comment) {
                var commentTemplate = '<li class="mdc-list-item comment-box comment-list-item">' +
                    '<img class="' + comment.user + ' avatar"src="img/avatars/' + comment.user + '.png" title="Credibility rate of this user" style="filter: brightness(30.6%) sepia(100) saturate(84.6) hue-rotate(337deg);" />' +
                    '<div>' +
                    '<a href="userProfile.html?user=' + comment.user + '">' + comment.user + '</a>' +
                    comment.text +
                    '</div>' +
                    '</li>';
                return commentTemplate;
            }

            //set author avatar
            function SetUserAvatar(author, isStoryAuthor) {
                var userUrl = "https://immigrant-news.firebaseio.com//users/" + author + ".json";

                if (isStoryAuthor) {
                    $('#username').text(author);
                    $('#user-avatar').attr('src', 'img/avatars/' + author + '.png');
                }
                else {
                    $('.'+author).attr('src', 'img/avatars/' + author + '.png');
                }
            }

            //get credibility color
            function GetCredibilityColor(percentage) {
                if (percentage <= 40) {
                    return '#ff0000';
                }
                else if(percentage > 40 && percentage <= 60) {
                    return '#ff8000';
                }
                else if (percentage > 60 && percentage < 80) {
                    return '#bfff00';
                }
                else {
                    return '#31b404';
                } 
            }

            function SaveCommentary(commentary) {
                var ref = firebase.database().ref("/stories/story" + currentStory + "/comments");
                var commentName = 'comment-' + currentStory + '-';
                var countCommentaries = 0;
                ref.once('value', function (snapshot) {
                    countCommentaries = snapshot.numChildren()+1;
                    commentName += countCommentaries;
                    var obj = {};
                    obj[commentName] = {
                        'text': commentary,
                        'user': currentUser
                    };
                    ref.update(obj); // Updates only the specified attributes
                    $('#commentaryInputText').val('');
                    $('#addCommentary').attr('disabled', false);
                    $('#addCommentarySection').hide();

                    //reload all comments
                    $('#storyComments').append(GetCommnetaryTemplate({ user: currentUser, text: commentary }));
                    //set the commentary user credibility avatar
                    SetUserAvatar(currentUser, false);
                   // alert('Comment was added');

                });
            }

            

            //add commentary button action
            $('#addCommentary').click(function () {
                $(this).attr('disabled', true);
                $('#addCommentarySection').show();
            });

            //when cancel adding commentary is clicked
            $('#cancelCommentButton').click(function () {
                $('#addCommentary').attr('disabled', false);
                $('#addCommentarySection').hide();
            });

            //when add a commentary button is clicked
            $('#addCommentButton').click(function () {
                //get the comment from the input
                var commentary = $('#commentaryInputText').val();
                commentary = $.trim(commentary);
                if (commentary.length == 0) {
                    alert('Commentary cannot be empty');
                    return;
                }
                if (commentary.length < 10) {
                    alert('the comment should have at least 10 letters');
                    return;
                }
                SaveCommentary(commentary);
                
               // alert(commentary);
            }); 

            
            //hide adding a new commentary section
            $('#addCommentarySection').hide();

            //update story validation
            function SetStoryValidation(validations) {
                var validCount = 0;
                var invalidCount = 0;
                var validity = 0;
                $.each(validations, function (index, value) {
                    if (value.vote == 'valid') validCount += 1;
                    else if (value.vote == 'invalid') invalidCount += 1;
                });
                validity = validCount - invalidCount;
               
                if (validity < 0) {

                    $('#contributionsButton').addClass('unverified');
                    $('#contributionsButton').text(validity);
                    return;
                }
                else if(validity >0){
                    $('#contributionsButton').addClass('verified');
                    $('#contributionsButton').text('+' + validity);
                    return;
                }
                $('#contributionsButton').addClass('no-voted');
                $('#contributionsButton').text(validity);
            }
        });
    </script>
</body>
</html>